<!DOCTYPE html>
<html>
<head>
    <title>Amazon Price Extraction Test - $44.08</title>
    <!-- 
    Test fixture for Amazon price extraction issue
    Tests the specific case where price should be $44.08 (not $4.08)
    This HTML structure reproduces the Amazon page that was causing extraction issues
    -->
</head>
<body>
    <div id="sns-tiered-price">
        <div class="a-section a-spacing-none aok-align-center aok-relative">
            <span class="a-price aok-align-center reinventPricePriceToPayMargin priceToPay" data-a-size="xl" data-a-color="base">
                <span class="a-offscreen"> </span>
                <span aria-hidden="true">
                    <span class="a-price-symbol">$</span>
                    <span class="a-price-whole">44<span class="a-price-decimal">.</span></span>
                    <span class="a-price-fraction">08</span>
                </span>
            </span>
        </div>
    </div>

    <script>
        // Copy the updated extractPrice function from content.js
        function extractPrice() {
            // Priority order: most specific to most general selectors
            const selectors = [
                // Current price selectors (highest priority)
                '.a-price.a-text-price.a-size-medium.apexPriceToPay .a-offscreen',
                '.a-price-current .a-offscreen',
                '.a-price.a-text-price .a-offscreen',
                '[data-automation-id="product-price"] .a-price .a-offscreen',
                
                // New specific selector for the problematic case
                '#sns-tiered-price .a-price .a-offscreen',
                '.priceToPay .a-offscreen',
                
                // Alternative current price selectors
                '.a-price.a-text-normal .a-offscreen',
                '.a-price .a-offscreen'
            ];
            
            // Try each selector in priority order
            for (const selector of selectors) {
                const element = document.querySelector(selector);
                if (element && element.textContent.trim()) {
                    const priceText = element.textContent.trim();
                    console.log(`Found price with selector "${selector}": "${priceText}"`);
                    
                    // Extract price from text (handle formats like $44.08, 44.08, etc.)
                    const priceMatch = priceText.match(/[\d,]+\.?\d*/);
                    if (priceMatch) {
                        const price = parseFloat(priceMatch[0].replace(/,/g, ''));
                        // Skip unreasonably low prices (likely fragments)
                        if (price >= 0.01) {
                            console.log(`Extracted price: $${price}`);
                            return price;
                        }
                    }
                }
            }
            
            // Try to find Amazon's specific price structure
            const priceElements = document.querySelectorAll('.a-price');
            for (const priceEl of priceElements) {
                const wholePriceEl = priceEl.querySelector('.a-price-whole');
                const fractionPriceEl = priceEl.querySelector('.a-price-fraction');
                
                if (wholePriceEl && fractionPriceEl) {
                    // Get the full text content, handling nested elements properly
                    const wholeText = wholePriceEl.textContent || wholePriceEl.innerText || '';
                    const fractionText = fractionPriceEl.textContent || fractionPriceEl.innerText || '';
                    
                    // Extract only digits from each part - but handle the decimal point issue
                    // The whole part might contain "44." so we need to extract just the number part before the decimal
                    let whole = wholeText.replace(/[^\d]/g, '');
                    const fraction = fractionText.replace(/[^\d]/g, '');
                    
                    // Special handling: if wholeText contains digits followed by a decimal, extract just the digits
                    const wholeMatch = wholeText.match(/(\d+)/);
                    if (wholeMatch) {
                        whole = wholeMatch[1];
                    }
                    
                    console.log(`DEBUG: wholeText="${wholeText}", fractionText="${fractionText}", whole="${whole}", fraction="${fraction}"`);
                    
                    if (whole && fraction) {
                        const price = parseFloat(`${whole}.${fraction}`);
                        console.log(`Extracted price from parts (whole: "${wholeText}" -> "${whole}", fraction: "${fractionText}" -> "${fraction}"): $${price}`);
                        
                        // Validate price range
                        if (price >= 0.01 && price <= 10000) {
                            return price;
                        }
                    }
                }
                
                // Alternative: try to get the full price from the visible aria-hidden span
                const visiblePriceSpan = priceEl.querySelector('[aria-hidden="true"]');
                if (visiblePriceSpan) {
                    const fullPriceText = visiblePriceSpan.textContent || '';
                    console.log(`DEBUG: Found aria-hidden span with text: "${fullPriceText}"`);
                    
                    // Try to extract price pattern like "$44.08"
                    const priceMatch = fullPriceText.match(/\$?(\d+\.?\d*)/);
                    if (priceMatch) {
                        const price = parseFloat(priceMatch[1]);
                        if (price >= 0.01 && price <= 10000) {
                            console.log(`Extracted price from aria-hidden span: $${price}`);
                            return price;
                        }
                    }
                }
            }
            
            console.log('No price found');
            return null;
        }

        // Test the function
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Testing price extraction...');
            
            // Debug: show what's in the a-offscreen element
            const offscreenEl = document.querySelector('.a-offscreen');
            console.log('a-offscreen element:', offscreenEl);
            console.log('a-offscreen textContent:', offscreenEl ? `"${offscreenEl.textContent}"` : 'null');
            
            // Debug: show what's in the price parts
            const wholeEl = document.querySelector('.a-price-whole');
            const fractionEl = document.querySelector('.a-price-fraction');
            console.log('a-price-whole element:', wholeEl);
            console.log('a-price-whole textContent:', wholeEl ? `"${wholeEl.textContent}"` : 'null');
            console.log('a-price-fraction element:', fractionEl);
            console.log('a-price-fraction textContent:', fractionEl ? `"${fractionEl.textContent}"` : 'null');
            
            const result = extractPrice();
            console.log('Final result:', result);
            
            document.body.innerHTML += `<h1>Result: $${result || 'NOT FOUND'}</h1>`;
        });
    </script>
</body>
</html>